#!/usr/bin/env python3
"""
Script de v√©rification int√©grale de la coh√©rence des noms de colonnes
entre l'application, la base de donn√©es et les KPI/API
"""

import psycopg
import os
from pathlib import Path
import re
import sys

# Connexion ‚Äî construit √† partir des variables d'environnement pour √©viter les secrets en clair
DSN = (
    os.getenv("DATABASE_URL")
    or os.getenv("PAYROLL_DSN")
    or (
        f"postgresql://{os.getenv('PAYROLL_DB_USER','payroll_app')}:"
        f"{os.getenv('PAYROLL_DB_PASSWORD','__SET_AT_DEPLOY__')}@"
        f"{os.getenv('PAYROLL_DB_HOST','localhost')}:{os.getenv('PAYROLL_DB_PORT','5432')}/"
        f"{os.getenv('PAYROLL_DB_NAME','payroll_db')}"
    )
)

if "__SET_AT_DEPLOY__" in DSN:
    print(
        "WARNING: PAYROLL_DB_PASSWORD non configur√© dans l'environnement ‚Äî v√©rifiez .env ou variables CI"
    )


def get_table_columns(conn, schema, table):
    """R√©cup√®re les colonnes d'une table"""
    with conn.cursor() as cur:
        cur.execute(
            """
            SELECT column_name, data_type 
            FROM information_schema.columns 
            WHERE table_schema = %s AND table_name = %s
            ORDER BY ordinal_position
        """,
            (schema, table),
        )
        return {row[0]: row[1] for row in cur.fetchall()}


def get_view_columns(conn, schema, view):
    """R√©cup√®re les colonnes d'une vue"""
    with conn.cursor() as cur:
        cur.execute(
            """
            SELECT column_name, data_type 
            FROM information_schema.columns 
            WHERE table_schema = %s AND table_name = %s
            ORDER BY ordinal_position
        """,
            (schema, view),
        )
        return {row[0]: row[1] for row in cur.fetchall()}


def get_view_definition(conn, schema, view):
    """R√©cup√®re la d√©finition SQL d'une vue"""
    with conn.cursor() as cur:
        cur.execute(
            """
            SELECT definition 
            FROM pg_views 
            WHERE schemaname = %s AND viewname = %s
        """,
            (schema, view),
        )
        result = cur.fetchone()
        return result[0] if result else None


def check_coherence():
    """V√©rifie la coh√©rence int√©grale"""
    print("=" * 80)
    print("üîç V√âRIFICATION INT√âGRALE DE COH√âRENCE DES COLONNES")
    print("=" * 80)

    issues = []
    warnings = []

    try:
        conn = psycopg.connect(DSN)

        # ====================================================================
        # 1. V√âRIFICATION DES TABLES DE BASE
        # ====================================================================
        print("\nüìã 1. V√©rification des tables de base")
        print("-" * 80)

        # Table core.employees
        emp_cols = get_table_columns(conn, "core", "employees")
        print(f"‚úÖ core.employees: {len(emp_cols)} colonnes trouv√©es")
        print(f"   Colonnes: {', '.join(sorted(emp_cols.keys()))}")

        # V√©rifier colonnes utilis√©es dans les vues mais absentes
        view_expected = ["categorie_emploi", "poste_budgetaire"]
        for col in view_expected:
            if col not in emp_cols:
                issues.append(
                    f"‚ùå CRITIQUE: core.employees n'a pas '{col}' mais utilis√© dans les vues!"
                )
                print(f"   ‚ùå CRITIQUE: {col} manquante (utilis√©e dans les vues)")

        # Table payroll.payroll_transactions
        trans_cols = get_table_columns(conn, "payroll", "payroll_transactions")
        print(f"‚úÖ payroll.payroll_transactions: {len(trans_cols)} colonnes trouv√©es")
        print(f"   Colonnes: {', '.join(sorted(trans_cols.keys()))}")

        expected_trans_cols = [
            "transaction_id",
            "employee_id",
            "pay_date",
            "pay_code",
            "amount_cents",
        ]
        for col in expected_trans_cols:
            if col not in trans_cols:
                issues.append(f"‚ùå payroll.payroll_transactions manque: {col}")
                print(f"   ‚ùå Colonne manquante: {col}")

        # ====================================================================
        # 2. V√âRIFICATION DES VUES KPI
        # ====================================================================
        print("\nüìä 2. V√©rification des vues KPI")
        print("-" * 80)

        kpi_views = {
            "paie": [
                "v_kpi_periode",
                "v_kpi_par_categorie_emploi",
                "v_kpi_par_code_paie",
                "v_kpi_par_poste_budgetaire",
                "v_kpi_par_employe_periode",
            ]
        }

        view_columns_map = {}
        for schema, views in kpi_views.items():
            for view in views:
                try:
                    cols = get_view_columns(conn, schema, view)
                    view_columns_map[f"{schema}.{view}"] = cols
                    print(f"\n‚úÖ {schema}.{view}: {len(cols)} colonnes")
                    print(f"   Colonnes: {', '.join(sorted(cols.keys()))}")

                    # V√©rifier colonnes obligatoires selon le contrat
                    required = [
                        "periode",
                        "date_paie",
                        "gains_brut",
                        "net_a_payer",
                        "nb_employes",
                        "cout_total",
                    ]
                    for req in required:
                        if req not in cols:
                            issues.append(f"‚ùå {schema}.{view} manque: {req}")
                            print(f"   ‚ùå Colonne manquante: {req}")

                    # V√©rifier pr√©sence de periode_paie (utilis√© par API)
                    if "periode_paie" not in cols and "periode" in cols:
                        warnings.append(
                            f"‚ö†Ô∏è {schema}.{view} n'a pas 'periode_paie' mais l'API l'utilise"
                        )
                        print(
                            f"   ‚ö†Ô∏è Attention: API utilise 'periode_paie' mais vue a 'periode'"
                        )

                except Exception as e:
                    issues.append(f"‚ùå Erreur acc√®s {schema}.{view}: {e}")
                    print(f"   ‚ùå Erreur: {e}")

        # ====================================================================
        # 3. V√âRIFICATION DES INCOH√âRENCES DANS LES VUES SQL
        # ====================================================================
        print("\nüîç 3. V√©rification des incoh√©rences dans les scripts SQL")
        print("-" * 80)

        sql_file = Path(__file__).parent / "admin_create_kpi_views.sql"
        if sql_file.exists():
            with open(sql_file, "r", encoding="utf-8") as f:
                sql_content = f.read()

            # V√©rifier r√©f√©rences √† payroll.employees (devrait √™tre core.employees)
            if "payroll.employees" in sql_content:
                issues.append(
                    "‚ùå CRITIQUE: admin_create_kpi_views.sql r√©f√©rence 'payroll.employees' au lieu de 'core.employees'"
                )
                print("   ‚ùå CRITIQUE: R√©f√©rence √† payroll.employees trouv√©e")
                print("      ‚Üí Devrait √™tre: core.employees")

            # V√©rifier r√©f√©rences √† e.categorie_emploi
            if "e.categorie_emploi" in sql_content or "categorie_emploi" in sql_content:
                if "categorie_emploi" not in emp_cols:
                    issues.append(
                        "‚ùå CRITIQUE: Les vues utilisent 'e.categorie_emploi' mais core.employees n'a pas cette colonne"
                    )
                    print(
                        "   ‚ùå CRITIQUE: e.categorie_emploi utilis√© mais colonne absente de core.employees"
                    )

            # V√©rifier r√©f√©rences √† e.poste_budgetaire
            if "e.poste_budgetaire" in sql_content or "poste_budgetaire" in sql_content:
                if "poste_budgetaire" not in emp_cols:
                    issues.append(
                        "‚ùå CRITIQUE: Les vues utilisent 'e.poste_budgetaire' mais core.employees n'a pas cette colonne"
                    )
                    print(
                        "   ‚ùå CRITIQUE: e.poste_budgetaire utilis√© mais colonne absente de core.employees"
                    )

        # ====================================================================
        # 4. V√âRIFICATION DES COLONNES DANS L'API
        # ====================================================================
        print("\nüîå 4. V√©rification des variant de colonnes utilis√©es dans l'API")
        print("-" * 80)

        api_file = Path(__file__).parent.parent / "api" / "routes" / "kpi.py"
        if api_file.exists():
            with open(api_file, "r", encoding="utf-8") as f:
                api_content = f.read()

            # Colonnes critiques utilis√©es par l'API
            api_issues = []

            # V√©rifier periode_paie vs periode
            if "periode_paie" in api_content:
                if "v_kpi_periode" in view_columns_map.get("paie.v_kpi_periode", {}):
                    if "periode_paie" not in view_columns_map.get(
                        "paie.v_kpi_periode", {}
                    ):
                        api_issues.append(
                            "‚ùå API utilise 'periode_paie' mais v_kpi_periode a 'periode'"
                        )
                        print("   ‚ùå API utilise 'periode_paie' mais vue a 'periode'")

            # V√©rifier cout_employeur_pnl vs cout_total
            if "cout_employeur_pnl" in api_content:
                if "cout_employeur_pnl" not in view_columns_map.get(
                    "paie.v_kpi_periode", {}
                ):
                    if "cout_total" in view_columns_map.get("paie.v_kpi_periode", {}):
                        api_issues.append(
                            "‚ùå API utilise 'cout_employeur_pnl' mais vue a 'cout_total'"
                        )
                        print(
                            "   ‚ùå API utilise 'cout_employeur_pnl' mais vue a 'cout_total'"
                        )

            # V√©rifier deductions_totales vs deductions_net
            if "deductions_totales" in api_content:
                if "deductions_totales" not in view_columns_map.get(
                    "paie.v_kpi_par_poste_budgetaire", {}
                ):
                    if "deductions_net" in view_columns_map.get(
                        "paie.v_kpi_par_poste_budgetaire", {}
                    ):
                        api_issues.append(
                            "‚ùå API utilise 'deductions_totales' mais vue a 'deductions_net'"
                        )
                        print(
                            "   ‚ùå API utilise 'deductions_totales' mais vue a 'deductions_net'"
                        )

            issues.extend(api_issues)

        # ====================================================================
        # 5. V√âRIFICATION DES JOINS ERRON√âS
        # ====================================================================
        print("\nüîó 5. V√©rification des JOINs")
        print("-" * 80)

        if sql_file.exists():
            with open(sql_file, "r", encoding="utf-8") as f:
                sql_content = f.read()

            # V√©rifier JOIN avec payroll.employees
            if (
                "LEFT JOIN payroll.employees" in sql_content
                or "JOIN payroll.employees" in sql_content
            ):
                issues.append(
                    "‚ùå CRITIQUE: JOIN avec payroll.employees - devrait √™tre core.employees"
                )
                print("   ‚ùå CRITIQUE: JOIN utilise payroll.employees")
                print(
                    "      ‚Üí Devrait √™tre: LEFT JOIN paie.stg_paie_transactions s ON t.source_file = s.source_file AND t.source_row_number = s.source_row_number"
                )

        # ====================================================================
        # 6. V√âRIFICATION DES D√âFINITIONS DE VUES
        # ====================================================================
        print("\nüìù 6. V√©rification des d√©finitions de vues")
        print("-" * 80)

        for view_path, view_cols in view_columns_map.items():
            schema, view = view_path.split(".")
            view_def = get_view_definition(conn, schema, view)
            if view_def:
                # V√©rifier r√©f√©rences √† payroll.employees dans la d√©finition
                if "payroll.employees" in view_def.lower():
                    issues.append(
                        f"‚ùå CRITIQUE: {view_path} r√©f√©rence payroll.employees dans sa d√©finition"
                    )
                    print(f"   ‚ùå {view_path} r√©f√©rence payroll.employees")

        # ====================================================================
        # 7. R√âSUM√â DES PROBL√àMES
        # ====================================================================
        print("\n" + "=" * 80)
        print("üìä R√âSUM√â DES PROBL√àMES D√âTECT√âS")
        print("=" * 80)

        if not issues and not warnings:
            print("‚úÖ Aucun probl√®me d√©tect√© - Tout est coh√©rent!")
        else:
            if issues:
                print(f"\n‚ùå {len(issues)} PROBL√àME(S) CRITIQUE(S):\n")
                for i, issue in enumerate(issues, 1):
                    print(f"   {i}. {issue}")

            if warnings:
                print(f"\n‚ö†Ô∏è {len(warnings)} AVERTISSEMENT(S):\n")
                for i, warning in enumerate(warnings, 1):
                    print(f"   {i}. {warning}")

        conn.close()
        return len(issues) == 0

    except Exception as e:
        print(f"‚ùå Erreur lors de la v√©rification: {e}")
        import traceback

        traceback.print_exc()
        return False


if __name__ == "__main__":
    success = check_coherence()
    sys.exit(0 if success else 1)
