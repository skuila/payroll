<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
    <meta http-equiv="X-UA-Compatible" content="ie=edge"/>
    <title>Gestion Périodes - PayrollAnalyzer</title>
    <link href="./dist/css/tabler.min.css?1692870487" rel="stylesheet"/>
    <link href="./dist/css/tabler-vendors.min.css?1692870487" rel="stylesheet"/>
    <style>
      /* OFFLINE: CDN Inter removed - using system font stack */
      :root {
      	--tblr-font-sans-serif: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      }
    </style>
  </head>
  <body>
    <script src="./dist/js/tabler.min.js?1692870487" defer></script>
    
    <script>
      window.fmtDate = function(dateStr) {
        try {
          return new Intl.DateTimeFormat('fr-CA', { dateStyle: 'medium' }).format(new Date(dateStr));
        } catch (e) {
          return dateStr;
        }
      };
    </script>
    
    <div class="page">
      <!-- Sidebar (même que database.html) -->
      <aside class="navbar navbar-vertical navbar-expand-lg" data-bs-theme="dark">
        <div class="container-fluid">
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#sidebar-menu">
            <span class="navbar-toggler-icon"></span>
          </button>
          <h1 class="navbar-brand navbar-brand-autodark">
            <a href="./index.html">
              <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-receipt" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                <path d="M5 21v-16a2 2 0 0 1 2 -2h10a2 2 0 0 1 2 2v16l-3 -2l-2 2l-2 -2l-2 2l-2 -2l-3 2"></path>
                <path d="M14 8h-2.5a1.5 1.5 0 0 0 0 3h1a1.5 1.5 0 0 1 0 3h-2.5m2 0v1.5m0 -9v1.5"></path>
              </svg>
              PayrollAnalyzer
            </a>
          </h1>
          <div class="collapse navbar-collapse" id="sidebar-menu">
            <ul class="navbar-nav pt-lg-3">
              <li class="nav-item"><a class="nav-link" href="./index.html"><span class="nav-link-icon d-md-none d-lg-inline-block"><svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 12l-2 0l9 -9l9 9l-2 0" /><path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" /><path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" /></svg></span><span class="nav-link-title">Accueil</span></a></li>
              <li class="nav-item active"><a class="nav-link" href="./database.html"><span class="nav-link-icon d-md-none d-lg-inline-block"><svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 6m-8 0a8 3 0 1 0 16 0a8 3 0 1 0 -16 0" /><path d="M4 6v6a8 3 0 0 0 16 0v-6" /><path d="M4 12v6a8 3 0 0 0 16 0v-6" /></svg></span><span class="nav-link-title">Base de données</span></a></li>
              <li class="nav-item"><a class="nav-link" href="./assistant.html"><span class="nav-link-icon d-md-none d-lg-inline-block"><svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M8 9h8" /><path d="M8 13h6" /><path d="M18 4a3 3 0 0 1 3 3v8a3 3 0 0 1 -3 3h-5l-5 3v-3h-2a3 3 0 0 1 -3 -3v-8a3 3 0 0 1 3 -3h12z" /></svg></span><span class="nav-link-title">Assistant IA</span></a></li>
              <li class="nav-item"><a class="nav-link" href="./import.html"><span class="nav-link-icon d-md-none d-lg-inline-block"><svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 18a4.6 4.4 0 0 1 0 -9a5 4.5 0 0 1 11 2h1a3.5 3.5 0 0 1 0 7h-1" /><path d="M9 15l3 -3l3 3" /><path d="M12 12l0 9" /></svg></span><span class="nav-link-title">Importer des données</span></a></li>
            </ul>
          </div>
        </div>
      </aside>
      
      <!-- Page content -->
      <div class="page-wrapper">
        <div class="page-header d-print-none">
          <div class="container-xl">
            <div class="row g-2 align-items-center">
              <div class="col">
                <div class="page-pretitle">
                  <a href="./database.html">Base de données</a>
                </div>
                <h2 class="page-title">Gestion des Périodes de Paie</h2>
              </div>
              <div class="col-auto ms-auto d-print-none">
                <div class="btn-list">
                  <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modal-add-period">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 5l0 14" /><path d="M5 12l14 0" /></svg>
                    Ajouter une période
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="page-body">
          <div class="container-xl">
            <div class="row row-cards">
              <div class="col-12">
                <div class="card">
                  <div class="card-header">
                    <h3 class="card-title">Toutes les périodes</h3>
                    <div class="ms-auto">
                      <select class="form-select" id="filter-year" onchange="loadPeriods()">
                        <option value="">Toutes les années</option>
                      </select>
                    </div>
                  </div>
                  <div class="table-responsive">
                    <table class="table table-vcenter card-table">
                      <thead>
                        <tr>
                          <th>Date de paie</th>
                          <th>Année</th>
                          <th>Séquence</th>
                          <th>Statut</th>
                          <th>Transactions</th>
                          <th>Fermée par</th>
                          <th class="w-1">Actions</th>
                        </tr>
                      </thead>
                      <tbody id="periods-table-body">
                        <tr>
                          <td colspan="7" class="text-center text-secondary">
                            <div class="py-4">Chargement...</div>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Modal: Ajouter période -->
    <div class="modal modal-blur fade" id="modal-add-period" tabindex="-1" role="dialog" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Ajouter une période de paie</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <form id="form-add-period">
            <div class="modal-body">
              <div class="mb-3">
                <label class="form-label required">Date de paie</label>
                <input type="date" class="form-control" id="add-pay-date" required>
                <small class="form-hint">Format: YYYY-MM-DD (ex: 2025-01-15)</small>
              </div>
              <div class="mb-3">
                <label class="form-label">Statut</label>
                <select class="form-select" id="add-status">
                  <option value="ouverte" selected>Ouverte</option>
                  <option value="fermée">Fermée</option>
                </select>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn me-auto" data-bs-dismiss="modal">Annuler</button>
              <button type="submit" class="btn btn-primary">Créer la période</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    
    <!-- WebChannel -->
    <script src="qrc:///qtwebchannel/qwebchannel.js"></script>
    <script>
      let appBridge = null;
      
      // Helper pour appels WebChannel asynchrones
      async function callBridge(methodName, ...args) {
        if (!appBridge) throw new Error('AppBridge non disponible');
        const resultJson = await Promise.resolve(appBridge[methodName](...args));
        return JSON.parse(resultJson);
      }
      
      document.addEventListener('DOMContentLoaded', function() {
        new QWebChannel(qt.webChannelTransport, function(channel) {
          appBridge = channel.objects.AppBridge;
          console.log('✓ WebChannel connecté (periods.html)');
          
          loadPeriods();
          populateYearFilter();
        });
        
        // Form submit
        document.getElementById('form-add-period').addEventListener('submit', function(e) {
          e.preventDefault();
          addPeriod();
        });
      });
      
      async function loadPeriods() {
        const filterYear = document.getElementById('filter-year').value;
        
        try {
          let periods;
          periods = await callBridge('get_periods', filterYear);
          
          const tbody = document.getElementById('periods-table-body');
          
          if (!periods || periods.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-secondary py-4">Aucune période trouvée</td></tr>';
            return;
          }
          
          tbody.innerHTML = periods.map(p => {
            const statusBadge = p.status === 'ouverte' ? 'success' : (p.status === 'fermée' ? 'warning' : 'secondary');
            
            return `
              <tr>
                <td><strong>${window.fmtDate(p.pay_date)}</strong></td>
                <td>${p.pay_year}</td>
                <td>${p.period_seq_in_year}</td>
                <td><span class="badge bg-${statusBadge}">${p.status}</span></td>
                <td>${(p.transaction_count || 0).toLocaleString('fr-CA')}</td>
                <td>${p.closed_by || '-'}</td>
                <td>
                  <div class="btn-group btn-group-sm">
                    ${p.transaction_count > 0 ?
                      `<a href="./period-report.html?date=${p.pay_date}" class="btn btn-primary" title="Voir rapport">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="16" height="16" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 5h-2a2 2 0 0 0 -2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-12a2 2 0 0 0 -2 -2h-2" /><path d="M9 3m0 2a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v0a2 2 0 0 1 -2 2h-2a2 2 0 0 1 -2 -2z" /><path d="M9 12l.01 0" /><path d="M13 12l2 0" /><path d="M9 16l.01 0" /><path d="M13 16l2 0" /></svg>
                      </a>` : ''}
                    ${p.status === 'ouverte' ? 
                      `<button class="btn btn-warning" onclick="closePeriod('${p.period_id}', '${p.pay_date}')" title="Fermer">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="16" height="16" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 13a2 2 0 0 1 2 -2h10a2 2 0 0 1 2 2v6a2 2 0 0 1 -2 2h-10a2 2 0 0 1 -2 -2v-6z" /><path d="M11 16a1 1 0 1 0 2 0a1 1 0 0 0 -2 0" /><path d="M8 11v-4a4 4 0 1 1 8 0v4" /></svg>
                      </button>` : ''}
                    ${p.status === 'fermée' ? 
                      `<button class="btn btn-success" onclick="reopenPeriod('${p.period_id}', '${p.pay_date}')" title="Réouvrir">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="16" height="16" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 11m0 2a2 2 0 0 1 2 -2h10a2 2 0 0 1 2 2v6a2 2 0 0 1 -2 2h-10a2 2 0 0 1 -2 -2z" /><path d="M12 16m-1 0a1 1 0 1 0 2 0a1 1 0 1 0 -2 0" /><path d="M8 11v-5a4 4 0 0 1 8 0" /></svg>
                      </button>` : ''}
                    ${p.transaction_count === 0 ?
                      `<button class="btn btn-danger" onclick="deletePeriod('${p.period_id}', '${p.pay_date}')" title="Supprimer">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="16" height="16" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 7l16 0" /><path d="M10 11l0 6" /><path d="M14 11l0 6" /><path d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12" /><path d="M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3" /></svg>
                      </button>` : ''}
                  </div>
                </td>
              </tr>
            `;
          }).join('');
          
          console.log('✓ Périodes chargées:', periods.length);
        } catch (error) {
          console.error('Erreur chargement périodes:', error);
        }
      }
      
      function populateYearFilter() {
        const currentYear = new Date().getFullYear();
        const select = document.getElementById('filter-year');
        
        for (let year = currentYear; year >= currentYear - 20; year--) {
          const option = document.createElement('option');
          option.value = year;
          option.textContent = year;
          select.appendChild(option);
        }
      }
      
      async function addPeriod() {
        const payDate = document.getElementById('add-pay-date').value;
        const status = document.getElementById('add-status').value;
        
        if (!payDate) {
          alert('Veuillez saisir une date de paie');
          return;
        }
        
        try {
          const result = await callBridge('add_period', payDate, status);
          
          if (result.success) {
            alert('✓ Période créée avec succès !');
            bootstrap.Modal.getInstance(document.getElementById('modal-add-period')).hide();
            document.getElementById('form-add-period').reset();
            loadPeriods();
          } else {
            alert('❌ Erreur: ' + result.message);
          }
        } catch (error) {
          console.error('Erreur ajout période:', error);
          alert('❌ Erreur: ' + error);
        }
      }
      
      async function closePeriod(periodId, payDate) {
        if (!confirm(`Fermer la période du ${window.fmtDate(payDate)} ?\n\nAucune modification ne sera plus possible.`)) return;
        
        try {
          const result = await callBridge('close_period', periodId);
          
          if (result.success) {
            alert('✓ Période fermée avec succès !');
            loadPeriods();
          } else {
            alert('❌ Erreur: ' + result.message);
          }
        } catch (error) {
          console.error('Erreur fermeture période:', error);
          alert('❌ Erreur: ' + error);
        }
      }
      
      async function reopenPeriod(periodId, payDate) {
        if (!confirm(`Réouvrir la période du ${window.fmtDate(payDate)} ?`)) return;
        
        try {
          const result = await callBridge('reopen_period', periodId);
          
          if (result.success) {
            alert('✓ Période réouverte avec succès !');
            loadPeriods();
          } else {
            alert('❌ Erreur: ' + result.message);
          }
        } catch (error) {
          console.error('Erreur réouverture période:', error);
          alert('❌ Erreur: ' + error);
        }
      }
      
      async function deletePeriod(periodId, payDate) {
        if (!confirm(`⚠️ SUPPRIMER la période du ${window.fmtDate(payDate)} ?\n\nCette action est irréversible.`)) return;
        
        try {
          const result = await callBridge('delete_period', periodId);
          
          if (result.success) {
            alert('✓ Période supprimée avec succès !');
            loadPeriods();
          } else {
            alert('❌ Erreur: ' + result.message);
          }
        } catch (error) {
          console.error('Erreur suppression période:', error);
          alert('❌ Erreur: ' + error);
        }
      }
    </script>
  </body>
</html>

