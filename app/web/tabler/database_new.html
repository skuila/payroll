<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
    <meta http-equiv="X-UA-Compatible" content="ie=edge"/>
    <title>Gestion des Donn√©es - PayrollAnalyzer</title>
    <link href="./dist/css/tabler.min.css?1692870487" rel="stylesheet"/>
    <link href="./dist/css/tabler-vendors.min.css?1692870487" rel="stylesheet"/>
    <style>
      :root {
        --tblr-font-sans-serif: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      }
      body {
        font-feature-settings: "cv03", "cv04", "cv11";
        background-color: #f5f7fb;
      }
      .stat-number {
        font-size: 2rem;
        font-weight: 700;
        color: #0054a6;
      }
      .stat-label {
        color: #6c757d;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      .action-card {
        transition: all 0.2s ease;
        cursor: pointer;
        border: 1px solid #e6e7e9;
      }
      .action-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        border-color: #0054a6;
      }
      .status-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 0.5rem;
      }
      .status-online { background-color: #2fb344; }
      .status-offline { background-color: #d63939; }
      .card { box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
    </style>
  </head>
  <body>
    <script src="./dist/js/tabler.min.js?1692870487" defer></script>
    
    <script>
      window.fmtCad = function(value) {
        try {
          return new Intl.NumberFormat('fr-CA', {
            style: 'currency',
            currency: 'CAD',
            currencyDisplay: 'narrowSymbol',
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
          }).format(value);
        } catch (e) {
          return String(value).replace('.', ',') + ' $';
        }
      };
      
      window.fmtDate = function(dateStr) {
        try {
          return new Intl.DateTimeFormat('fr-CA', { dateStyle: 'medium' }).format(new Date(dateStr));
        } catch (e) {
          return dateStr;
        }
      };
    </script>
    
    <div class="page">
      <!-- Sidebar -->
      <aside class="navbar navbar-vertical navbar-expand-lg" data-bs-theme="dark">
        <div class="container-fluid">
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#sidebar-menu">
            <span class="navbar-toggler-icon"></span>
          </button>
          <h1 class="navbar-brand navbar-brand-autodark">
            <a href="./index.html">
              <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-receipt" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                <path d="M5 21v-16a2 2 0 0 1 2 -2h10a2 2 0 0 1 2 2v16l-3 -2l-2 2l-2 -2l-2 2l-2 -2l-3 2"></path>
                <path d="M14 8h-2.5a1.5 1.5 0 0 0 0 3h1a1.5 1.5 0 0 1 0 3h-2.5m2 0v1.5m0 -9v1.5"></path>
              </svg>
              PayrollAnalyzer
            </a>
          </h1>
          <div class="collapse navbar-collapse" id="sidebar-menu">
            <ul class="navbar-nav pt-lg-3">
              <li class="nav-item"><a class="nav-link" href="./index.html"><span class="nav-link-title">Accueil</span></a></li>
              <li class="nav-item"><a class="nav-link" href="./employees.html"><span class="nav-link-title">Employ√©s</span></a></li>
              <li class="nav-item active"><a class="nav-link" href="./database.html"><span class="nav-link-title">Gestion des donn√©es</span></a></li>
              <li class="nav-item"><a class="nav-link" href="./assistant.html"><span class="nav-link-title">Assistant IA</span></a></li>
              <li class="nav-item"><a class="nav-link" href="./import.html"><span class="nav-link-title">Importer</span></a></li>
              <li class="nav-item"><a class="nav-link" href="./data-viewer.html"><span class="nav-link-title">Visualiser</span></a></li>
            </ul>
          </div>
        </div>
      </aside>
      
      <!-- Page content -->
      <div class="page-wrapper">
        <div class="page-header d-print-none">
          <div class="container-xl">
            <div class="row g-2 align-items-center">
              <div class="col">
                <h2 class="page-title">Gestion des Donn√©es</h2>
                <div class="text-secondary mt-1">Vue d'ensemble et maintenance</div>
              </div>
              <div class="col-auto ms-auto d-print-none">
                <button class="btn btn-primary" onclick="refreshAll()">
                  <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"><path d="M20 11a8.1 8.1 0 0 0 -15.5 -2m-.5 -4v4h4M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"/></svg>
                  Actualiser
                </button>
              </div>
            </div>
          </div>
        </div>
        
        <div class="page-body">
          <div class="container-xl">
            
            <!-- Vue d'ensemble -->
            <div class="row row-cards mb-3">
              <div class="col-12">
                <div class="card">
                  <div class="card-header">
                    <h3 class="card-title">√âtat du syst√®me</h3>
                    <div class="ms-auto">
                      <span class="status-dot status-online" id="connection-indicator"></span>
                      <span id="connection-status">Connect√©</span>
                    </div>
                  </div>
                  <div class="card-body">
                    <div class="row g-3">
                      <div class="col-md-3">
                        <div class="text-center">
                          <div class="stat-number" id="stat-employees">-</div>
                          <div class="stat-label">Employ√©s actifs</div>
                        </div>
                      </div>
                      <div class="col-md-3">
                        <div class="text-center">
                          <div class="stat-number" id="stat-periods">-</div>
                          <div class="stat-label">P√©riodes de paie</div>
                        </div>
                      </div>
                      <div class="col-md-3">
                        <div class="text-center">
                          <div class="stat-number" id="stat-transactions">-</div>
                          <div class="stat-label">Transactions enregistr√©es</div>
                        </div>
                      </div>
                      <div class="col-md-3">
                        <div class="text-center">
                          <div class="stat-number" id="stat-db-size">-</div>
                          <div class="stat-label">Taille totale</div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Actions rapides -->
            <div class="row row-cards mb-3">
              <div class="col-12">
                <h3 class="mb-3">Actions de maintenance</h3>
              </div>
              
              <div class="col-md-4">
                <div class="card action-card" onclick="optimizeDatabase()">
                  <div class="card-body">
                    <div class="d-flex align-items-center">
                      <div class="me-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-lg text-primary" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"><path d="M10.325 4.317c.426 -1.756 2.924 -1.756 3.35 0a1.724 1.724 0 0 0 2.573 1.066c1.543 -.94 3.31 .826 2.37 2.37a1.724 1.724 0 0 0 1.065 2.572c1.756 .426 1.756 2.924 0 3.35a1.724 1.724 0 0 0 -1.066 2.573c.94 1.543 -.826 3.31 -2.37 2.37a1.724 1.724 0 0 0 -2.572 1.065c-.426 1.756 -2.924 1.756 -3.35 0a1.724 1.724 0 0 0 -2.573 -1.066c-1.543 .94 -3.31 -.826 -2.37 -2.37a1.724 1.724 0 0 0 -1.065 -2.572c-1.756 -.426 -1.756 -2.924 0 -3.35a1.724 1.724 0 0 0 1.066 -2.573c-.94 -1.543 .826 -3.31 2.37 -2.37c1 .608 2.296 .07 2.572 -1.065zM9 12a3 3 0 1 0 6 0a3 3 0 0 0 -6 0"/></svg>
                      </div>
                      <div>
                        <h4 class="mb-1">Optimiser les performances</h4>
                        <p class="text-secondary mb-0 small">Actualiser les statistiques internes</p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="col-md-4">
                <div class="card action-card" onclick="viewPeriods()">
                  <div class="card-body">
                    <div class="d-flex align-items-center">
                      <div class="me-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-lg text-info" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"><path d="M4 7a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v12a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2v-12zM16 3v4M8 3v4M4 11h16"/></svg>
                      </div>
                      <div>
                        <h4 class="mb-1">G√©rer les p√©riodes</h4>
                        <p class="text-secondary mb-0 small">Ajouter, modifier ou fermer une p√©riode</p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="col-md-4">
                <div class="card action-card" onclick="exportData()">
                  <div class="card-body">
                    <div class="d-flex align-items-center">
                      <div class="me-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-lg text-success" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"><path d="M4 17v2a2 2 0 0 0 2 2h12a2 2 0 0 0 2 -2v-2M7 11l5 5l5 -5M12 4l0 12"/></svg>
                      </div>
                      <div>
                        <h4 class="mb-1">Exporter les donn√©es</h4>
                        <p class="text-secondary mb-0 small">T√©l√©charger un rapport complet</p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Informations syst√®me -->
            <div class="row row-cards">
              <div class="col-md-6">
                <div class="card">
                  <div class="card-header">
                    <h3 class="card-title">Informations de connexion</h3>
                  </div>
                  <div class="card-body">
                    <div id="connection-info">
                      <div class="text-center text-secondary py-3">Chargement...</div>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="col-md-6">
                <div class="card">
                  <div class="card-header">
                    <h3 class="card-title">Derni√®re activit√©</h3>
                  </div>
                  <div class="card-body">
                    <div id="activity-log">
                      <div class="text-center text-secondary py-3">Aucune activit√© r√©cente</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Zone de logs -->
            <div class="row row-cards mt-3">
              <div class="col-12">
                <div class="card">
                  <div class="card-header">
                    <h3 class="card-title">Journal d'activit√©</h3>
                    <div class="card-actions">
                      <button class="btn btn-sm btn-outline-secondary" onclick="clearLogs()">Effacer</button>
                    </div>
                  </div>
                  <div class="card-body">
                    <div id="logs-console" style="max-height: 200px; overflow-y: auto; background-color: #f8f9fa; padding: 1rem; border-radius: 4px; font-family: monospace; font-size: 0.875rem;">
                      <div class="text-secondary">Les √©v√©nements appara√Ætront ici...</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
          </div>
        </div>
      </div>
    </div>
    
    <!-- WebChannel -->
    <script src="qrc:///qtwebchannel/qwebchannel.js"></script>
    <script>
      let appBridge = null;
      
      async function callBridge(methodName, ...args) {
        if (!appBridge) throw new Error('AppBridge non disponible');
        const resultJson = await Promise.resolve(appBridge[methodName](...args));
        return JSON.parse(resultJson);
      }
      
      document.addEventListener('DOMContentLoaded', function() {
        console.log('üîÑ Chargement page Gestion des Donn√©es');
        new QWebChannel(qt.webChannelTransport, function(channel) {
          appBridge = channel.objects.AppBridge;
          console.log('‚úÖ Connexion √©tablie');
          
          loadConnectionInfo();
          loadDbStats();
        });
      });
      
      async function loadConnectionInfo() {
        try {
          const info = await callBridge('get_connection_info');
          
          document.getElementById('connection-info').innerHTML = `
            <table class="table table-sm">
              <tr><td class="text-secondary">Statut</td><td><span class="badge ${info.status === 'connected' ? 'bg-success' : 'bg-danger'}">${info.status === 'connected' ? 'Connect√©' : 'D√©connect√©'}</span></td></tr>
              <tr><td class="text-secondary">Serveur</td><td><code>${info.host || 'N/A'}:${info.port || 'N/A'}</code></td></tr>
              <tr><td class="text-secondary">Base</td><td><code>${info.database || 'N/A'}</code></td></tr>
              <tr><td class="text-secondary">Utilisateur</td><td><code>${info.user || 'N/A'}</code></td></tr>
            </table>
          `;
          
          const statusDot = document.getElementById('connection-indicator');
          const statusText = document.getElementById('connection-status');
          if (info.status === 'connected') {
            statusDot.className = 'status-dot status-online';
            statusText.textContent = 'Connect√©';
          } else {
            statusDot.className = 'status-dot status-offline';
            statusText.textContent = 'D√©connect√©';
          }
          
          log('info', 'Informations de connexion charg√©es');
        } catch (error) {
          log('error', 'Erreur chargement infos: ' + error);
        }
      }
      
      async function loadDbStats() {
        try {
          const stats = await callBridge('get_db_stats');
          
          document.getElementById('stat-employees').textContent = (stats.active_employees || 0).toLocaleString('fr-CA');
          document.getElementById('stat-periods').textContent = stats.total_periods || '-';
          document.getElementById('stat-transactions').textContent = (stats.total_transactions || 0).toLocaleString('fr-CA');
          document.getElementById('stat-db-size').textContent = stats.db_size_mb ? `${stats.db_size_mb} MB` : '-';
          
          log('success', 'Statistiques charg√©es');
        } catch (error) {
          log('error', 'Erreur chargement stats: ' + error);
        }
      }
      
      async function optimizeDatabase() {
        if (!confirm('Optimiser le syst√®me maintenant?\n\nCette op√©ration peut prendre quelques secondes.')) return;
        
        log('info', 'Optimisation en cours...');
        try {
          const result = await callBridge('run_analyze');
          if (result.success) {
            alert('‚úÖ Optimisation termin√©e avec succ√®s');
            log('success', 'Optimisation termin√©e');
          } else {
            alert('‚ùå Erreur: ' + result.message);
            log('error', result.message);
          }
        } catch (error) {
          alert('‚ùå Erreur: ' + error);
          log('error', 'Erreur optimisation: ' + error);
        }
      }
      
      function viewPeriods() {
        window.location.href = './periods.html';
      }
      
      async function exportData() {
        log('info', 'Export des donn√©es...');
        alert('Fonction d\'export √† venir...\n\nCette fonctionnalit√© sera disponible dans une prochaine mise √† jour.');
      }
      
      async function refreshAll() {
        log('info', 'Actualisation...');
        await loadConnectionInfo();
        await loadDbStats();
        log('success', 'Actualisation termin√©e');
      }
      
      function log(type, message) {
        const logs = document.getElementById('logs-console');
        if (!logs) return;
        
        const timestamp = new Date().toLocaleTimeString('fr-CA');
        const emoji = { success: '‚úÖ', error: '‚ùå', warning: '‚ö†Ô∏è', info: '‚ÑπÔ∏è' };
        const color = { success: 'text-success', error: 'text-danger', warning: 'text-warning', info: 'text-info' };
        
        const logEntry = document.createElement('div');
        logEntry.className = `${color[type] || 'text-secondary'} mb-1`;
        logEntry.textContent = `${timestamp} ${emoji[type] || '‚Ä¢'} ${message}`;
        
        logs.appendChild(logEntry);
        logs.scrollTop = logs.scrollHeight;
      }
      
      function clearLogs() {
        document.getElementById('logs-console').innerHTML = '<div class="text-secondary">Journal effac√©</div>';
      }
    </script>
  </body>
</html>
