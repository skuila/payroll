<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta http-equiv="X-UA-Compatible" content="ie=edge"/>
  <title>Assistant IA - Syst√®me de Contr√¥le de la Paie</title>
  <!-- CSS files -->
  <link href="./dist/css/tabler.min.css?1692870487" rel="stylesheet"/>
  <link href="./dist/css/tabler-vendors.min.css?1692870487" rel="stylesheet"/>
  <style>
    /* OFFLINE: CDN Inter removed - using system font stack */
    :root {
    	--tblr-font-sans-serif: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    }
    body {
    	font-feature-settings: "cv03", "cv04", "cv11";
    }
    #chat-messages {
      height: 500px;
      overflow-y: auto;
      padding: 1rem;
      background: #f8f9fa;
      border-radius: 0.5rem;
    }
    .message {
      margin-bottom: 1rem;
      padding: 0.75rem 1rem;
      border-radius: 0.5rem;
    }
    .message-user {
      background: #206bc4;
      color: white;
      margin-left: 3rem;
      text-align: right;
    }
    .message-ai {
      background: white;
      border: 1px solid #dee2e6;
      margin-right: 3rem;
    }
  </style>
</head>
<body>
  <script src="./dist/js/tabler.min.js?1692870487" defer></script>
  <div class="page">
    <!-- Sidebar (r√©utiliser depuis index.html - version simplifi√©e) -->
    <aside class="navbar navbar-vertical navbar-expand-lg" data-bs-theme="dark">
      <div class="container-fluid">
        <h1 class="navbar-brand navbar-brand-autodark">
          <a href="./index.html">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 13m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0"></path><path d="M13.45 11.55l2.05 -2.05"></path><path d="M6.4 20a9 9 0 1 1 11.2 0z"></path></svg>
            SCP
          </a>
        </h1>
        <div class="collapse navbar-collapse">
          <ul class="navbar-nav pt-lg-3">
            <li class="nav-item">
              <a class="nav-link" href="./index.html">
                <span class="nav-link-icon d-md-none d-lg-inline-block">
                  <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 12l-2 0l9 -9l9 9l-2 0l0 7a2 2 0 0 1 -2 2h-10a2 2 0 0 1 -2 -2l0 -7z" /><path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" /></svg>
                </span>
                <span class="nav-link-title">Accueil</span>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="./kpi-dashboard.html">
                <span class="nav-link-icon d-md-none d-lg-inline-block">
                  <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 17l6 -6l4 4l8 -8" /><path d="M14 7l7 0l0 7" /></svg>
                </span>
                <span class="nav-link-title">KPI Dashboard</span>
              </a>
            </li>

            <li class="nav-item active">
              <a class="nav-link" href="./assistant.html">
                <span class="nav-link-icon d-md-none d-lg-inline-block">
                  <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 12a9 9 0 1 0 18 0a9 9 0 0 0 -18 0" /><path d="M12 9h.01" /><path d="M11 12h1v4h1" /></svg>
                </span>
                <span class="nav-link-title">Assistant IA</span>
              </a>
            </li>
          </ul>
        </div>
      </div>
    </aside>
    
    <!-- Page content -->
    <div class="page-wrapper">
      <!-- Page header -->
      <div class="page-header d-print-none">
        <div class="container-xl">
          <div class="row g-2 align-items-center">
            <div class="col">
              <h2 class="page-title">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 12a9 9 0 1 0 18 0a9 9 0 0 0 -18 0" /><path d="M12 9h.01" /><path d="M11 12h1v4h1" /></svg>
                Assistant IA
              </h2>
              <div class="page-pretitle">
                Posez vos questions sur les donn√©es de paie
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Page body -->
      <div class="page-body">
        <div class="container-xl">
          <div class="row row-cards">
            <div class="col-12">
              <div class="card">
                <div class="card-header">
                  <h3 class="card-title">Conversation</h3>
                  <div class="card-actions">
                    <button class="btn btn-sm btn-outline-danger" id="clear-chat">
                      <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 7l16 0" /><path d="M10 11l0 6" /><path d="M14 11l0 6" /><path d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12" /><path d="M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3" /></svg>
                      Effacer
                    </button>
                  </div>
                </div>
                <div class="card-body">
                  <div id="chat-messages"></div>
                </div>
                <div class="card-footer">
                  <form id="question-form">
                    <div class="input-group">
                      <input type="text" id="question-input" class="form-control" placeholder="Posez votre question..." autocomplete="off" required>
                      <button type="submit" class="btn btn-primary">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M10 14l11 -11" /><path d="M21 3l-6.5 18a.55 .55 0 0 1 -1 0l-3.5 -7l-7 -3.5a.55 .55 0 0 1 0 -1l18 -6.5" /></svg>
                        Envoyer
                      </button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
            
            <!-- Suggestions card -->
            <div class="col-12">
              <div class="card">
                <div class="card-header">
                  <h3 class="card-title">Questions sugg√©r√©es</h3>
                </div>
                <div class="card-body">
                  <div class="row g-2">
                    <div class="col-md-6">
                      <button class="btn btn-outline-primary w-100 suggestion-btn" data-question="Quelle est la masse salariale totale ?">
                        Masse salariale totale ?
                      </button>
                    </div>
                    <div class="col-md-6">
                      <button class="btn btn-outline-primary w-100 suggestion-btn" data-question="Combien d'employ√©s actifs ?">
                        Combien d'employ√©s actifs ?
                      </button>
                    </div>
                    <div class="col-md-6">
                      <button class="btn btn-outline-primary w-100 suggestion-btn" data-question="Quel est le salaire net moyen ?">
                        Salaire net moyen ?
                      </button>
                    </div>
                    <div class="col-md-6">
                      <button class="btn btn-outline-primary w-100 suggestion-btn" data-question="Quelles sont les anomalies d√©tect√©es ?">
                        Anomalies d√©tect√©es ?
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- QWebChannel Bridge -->
  <script src="qrc:///qtwebchannel/qwebchannel.js"></script>
  <script>
    let appBridge = null;
    
    // Initialiser WebChannel
    new QWebChannel(qt.webChannelTransport, function(channel) {
      appBridge = channel.objects.AppBridge;  // Majuscule !
      console.log('‚úì WebChannel actif sur page assistant');
      
      // V√©rifier session
      checkSession();
    });
    
    // V√©rifier session utilisateur
    function checkSession() {
      if (!appBridge) return;
      
      const sessionJson = appBridge.check_session();
      const session = JSON.parse(sessionJson);
      
      if (!session.authenticated) {
        window.location.href = './login.html';
      }
    }
    
    // Gestion du formulaire
    document.getElementById('question-form')?.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const input = document.getElementById('question-input');
      const question = input.value.trim();
      
      if (!question || !appBridge) return;
      
      // Afficher la question de l'utilisateur
      addMessage(question, 'user');
      input.value = '';
      
      // Afficher √©tat de chargement
      const thinkingMsg = addMessage('ü§î R√©flexion en cours...', 'ai', true);
      
      try {
        // Appeler l'assistant IA
        const responseJson = appBridge.ask_ai(question, '');
        const response = JSON.parse(responseJson);
        
        // Retirer le message de chargement
        thinkingMsg.remove();
        
        // Afficher la r√©ponse
        addMessage(response.answer || response.message || 'Aucune r√©ponse', 'ai');
        
        // Afficher les suggestions si disponibles
        if (response.suggestions && response.suggestions.length > 0) {
          updateSuggestions(response.suggestions);
        }
        
      } catch (error) {
        console.error('Erreur ask_ai:', error);
        thinkingMsg.remove();
        addMessage('‚ùå Erreur: ' + error.message, 'ai');
      }
    });
    
    // Ajouter un message au chat
    function addMessage(text, type, isTemporary = false) {
      const messagesDiv = document.getElementById('chat-messages');
      const messageDiv = document.createElement('div');
      messageDiv.className = `message message-${type}`;
      messageDiv.textContent = text;
      
      if (isTemporary) {
        messageDiv.id = 'temp-message';
      }
      
      messagesDiv.appendChild(messageDiv);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
      
      return messageDiv;
    }
    
    // Effacer le chat
    document.getElementById('clear-chat')?.addEventListener('click', function() {
      document.getElementById('chat-messages').innerHTML = '';
    });
    
    // Boutons suggestions
    document.querySelectorAll('.suggestion-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        const question = this.getAttribute('data-question');
        document.getElementById('question-input').value = question;
        document.getElementById('question-form').dispatchEvent(new Event('submit'));
      });
    });
    
    // Mettre √† jour les suggestions
    function updateSuggestions(suggestions) {
      // TODO: Mettre √† jour dynamiquement les boutons de suggestion
      console.log('Nouvelles suggestions:', suggestions);
    }
  </script>
</body>
</html>

