<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Aperçu Liste Employés — PayrollAnalyzer</title>

  <!-- Tabler CSS (CDN) -->
  <link href="https://unpkg.com/tabler@1.0.0-beta8/dist/css/tabler.min.css" rel="stylesheet"/>

  <!-- DataTables CSS -->
  <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet"/>
  <link href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.bootstrap5.min.css" rel="stylesheet"/>

  <style>
    body { background:#f4f6fb; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial; }
    .badge-actif { background-color:#037c17; color:#fff; padding:.35rem .6rem; border-radius:.5rem; }
    .badge-inactif { background-color:#b46b6b; color:#fff; padding:.35rem .6rem; border-radius:.5rem; }
    .row-uppercase { background-color:#fff0f0 !important; } /* surlignage si nom en majuscules */
    .spark-canvas { width:120px; height:36px; display:block; }
    .arrow-up { color:#16a34a; font-weight:700; }
    .arrow-down { color:#dc2626; font-weight:700; }
    .arrow-neutral { color:#64748b; font-weight:600; }
    .controls { display:flex; gap:8px; align-items:center; margin-bottom:10px; }
    .legend { margin-top:8px; font-size:0.9rem; color:#475569; }
  </style>
</head>
<body>
  <div class="page">
    <div class="page-wrapper">
      <div class="page-header">
        <div class="container-xl">
          <h2 class="page-title">Liste des employés — Aperçu</h2>
          <div class="page-subtitle text-muted">Exemple visuel & prototype local</div>
        </div>
      </div>

      <div class="container-xl mt-3">
        <div class="card shadow-sm">
          <div class="card-body">

            <!-- Contrôles -->
            <div class="controls">
              <label for="pay-date" class="form-label me-2">Date de paie :</label>
              <input type="date" id="pay-date" class="form-control" style="width:160px" />
              <button id="btn-apply-date" class="btn btn-primary">Afficher</button>

              <div style="flex:1"></div>

              <div>
                <select id="filter-statut" class="form-select">
                  <option value="all">Tous</option>
                  <option value="actif">Actifs</option>
                  <option value="inactif">Anciens</option>
                </select>
              </div>
            </div>

            <!-- Table -->
            <div class="table-responsive">
              <table id="tbl-employees" class="table table-bordered table-hover w-100">
                <thead>
                  <tr>
                    <th>Nom</th>
                    <th>Matricule</th>
                    <th>Statut</th>
                    <th>Catégorie</th>
                    <th>Titre</th>
                    <th class="text-end">Salaire net ($)</th>
                    <th class="text-center">Δ %</th>
                    <th>Trend</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>

            <div class="legend">
              <strong>Note :</strong> les lignes en <span style="background:#fff0f0">rose</span> signifient que le nom est entièrement en MAJUSCULES (signalé). Amin Ajarar (exemple) est montré comme actif.
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Détails -->
  <div class="modal modal-blur fade" id="modalDetail" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle">Historique salaire</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
        </div>
        <div class="modal-body">
          <canvas id="modalChart" style="width:100%;height:320px"></canvas>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
        </div>
      </div>
    </div>
  </div>

  <!-- JS libs -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://unpkg.com/tabler@1.0.0-beta8/dist/js/tabler.min.js"></script>

  <!-- DataTables -->
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.bootstrap5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <script>
  (function(){


    const sampleEmployees = [
      {
        employee_id: 1,
        nom: "Amin Ajarar",
        matricule: "A001",
        statut: "actif",
        categorie: "Comptabilité",
        titre: "Agent de gestion comptable",
        salaire_net: 398464.35,
        salaire_prev: 370000.00,
        salary_trend: [
          {date:"2024-11-01", value: 360000},
          {date:"2024-12-01", value: 370000},
          {date:"2025-01-01", value: 398464.35}
        ]
      },
      {
        employee_id: 2,
        nom: "AMIN AJARAR",
        matricule: "A001",
        statut: "inactif",
        categorie: "Comptabilité",
        titre: "Ancien agent",
        salaire_net: 0,
        salaire_prev: 1200,
        salary_trend: [
          {date:"2024-11-01", value: 1200},
          {date:"2024-12-01", value: 0},
          {date:"2025-01-01", value: 0}
        ]
      },
      {
        employee_id: 3,
        nom: "Jean Allaaain",
        matricule: "B220",
        statut: "inactif",
        categorie: "Technique",
        titre: "Technicien",
        salaire_net: 800.00,
        salaire_prev: 1000.00,
        salary_trend: [
          {date:"2024-11-01", value: 950},
          {date:"2024-12-01", value: 1000},
          {date:"2025-01-01", value: 800}
        ]
      },
      {
        employee_id: 4,
        nom: "Marie Dupont",
        matricule: "C333",
        statut: "actif",
        categorie: "Administration",
        titre: "Chef bureau",
        salaire_net: 4200.50,
        salaire_prev: 4100.00,
        salary_trend: [
          {date:"2024-11-01", value: 3900},
          {date:"2024-12-01", value: 4100},
          {date:"2025-01-01", value: 4200.5}
        ]
      }
    ];


    function fmtMoney(n){ return new Intl.NumberFormat('fr-CA', {minimumFractionDigits:2, maximumFractionDigits:2}).format(Number(n)); }


    function computeDeltaPct(cur, prev){
      cur = Number(cur||0); prev = Number(prev||0);
      if(prev === 0){
        if(cur === 0) return {pct:0, dir: 'neutral'};
        return {pct: 100, dir: 'up'};
      }
      const pct = ((cur - prev)/Math.abs(prev))*100;
      return {pct: pct, dir: (pct>0.1 ? 'up' : (pct < -0.1 ? 'down' : 'neutral'))};
    }


    function renderDelta(cur, prev){
      const d = computeDeltaPct(cur, prev);
      const pctStr = (Math.abs(d.pct) >= 1 || d.pct===0) ? d.pct.toFixed(1)+'%' : d.pct.toFixed(2)+'%';
      if(d.dir === 'up') return `<span class="arrow-up">▲ ${pctStr}</span>`;
      if(d.dir === 'down') return `<span class="arrow-down">▼ ${pctStr}</span>`;
      return `<span class="arrow-neutral">— ${pctStr}</span>`;
    }


    function createSparkline(canvasId, trend){
      const node = document.getElementById(canvasId);
      if(!node) return;
      node.width = 140; node.height = 36;
      const ctx = node.getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: trend.map(t=>t.date),
          datasets: [{
            data: trend.map(t=>t.value),
            borderColor: '#0b69ff',
            backgroundColor: 'rgba(11,105,255,0.08)',
            tension: 0.3, pointRadius: 0
          }]
        },
        options: {
          responsive:false, maintainAspectRatio:false,
          scales:{ x:{display:false}, y:{display:false} },
          plugins:{ legend:{display:false}, tooltip:{ callbacks:{ label: ctx => fmtMoney(ctx.parsed.y) } } }
        }
      });
    }


    let modalChart = null;
    function openModalHistory(title, trend){
      document.getElementById('modalTitle').textContent = `Historique salaire — ${title}`;
      const ctx = document.getElementById('modalChart').getContext('2d');
      if(modalChart) modalChart.destroy();
      modalChart = new Chart(ctx, {
        type:'line',
        data:{ labels: trend.map(t=>t.date), datasets:[{ label:'Salaire net', data: trend.map(t=>t.value), borderColor:'#16a34a', backgroundColor:'rgba(22,163,74,0.08)', tension:0.2 }]},
        options:{ plugins:{ tooltip:{ callbacks:{ label: ctx => fmtMoney(ctx.parsed.y) } } } }
      });
      new tabler.Core.Modal(document.getElementById('modalDetail')).show();
    }


    function prepareRows(data){
      return data.map(r => {
        const isUpper = String(r.nom).trim() === String(r.nom).trim().toUpperCase();
        const deltaHtml = renderDelta(r.salaire_net, r.salaire_prev);
        return {
          employee_id: r.employee_id,
          nom: r.nom,
          matricule: r.matricule,
          statut: r.statut,
          categorie: r.categorie,
          titre: r.titre,
          salaire_net: r.salaire_net,
          salaire_prev: r.salaire_prev,
          deltaHtml: deltaHtml,
          salary_trend: r.salary_trend,
          is_upper: isUpper
        };
      });

